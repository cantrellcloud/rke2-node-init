# rke2nodeinit ‚Äî RKE2 Node Image Init for Air-Gapped Clusters (Ubuntu 24.04 LTS)

This repository lets you prepare a single Ubuntu 24.04 VM image that can later boot as an **RKE2 Server** or **RKE2 Agent** in **internet-limited / air-gapped** environments. It follows Rancher RKE2 air-gap practices and adds helpful prompts, validation, reporting, and logging so **entry-level admins** can operate safely and consistently across **three data centers** and **four production clusters**.

---

## Why this repo exists

- You want to build one golden VM image for both **RKE2 servers and agents**.
- Your clusters will run in **offline** or **internet-restricted** networks.
- You need **container images** staged locally and mirrored to a **private registry**.
- You want sane defaults, **simple YAML inputs**, strong **logging**, and **checks**.

---

## What this tool does

- **containerd-first runtime** (uses `containerd`+`nerdctl` when available; falls back to Docker only if containerd isn‚Äôt present; installs containerd if neither is present).
- **pull**: downloads RKE2 artifacts and **loads** the RKE2 image archive into the local runtime for caching.
- **push**: **retags + pushes** all locally cached images to your offline registry (writes a **pre-push manifest** and **SBOMs**).
- **image**: installs **RKE2 prerequisites**, trusts your registry CA, stages artifacts for offline use, **disables IPv6**, applies OS updates and **auto-reboots**.
- **server/agent**: sets static IP, hostname, optional single gateway, **multiple DNS** servers, and **search domains**. Enables the respective RKE2 service.
- **verify**: validates kernel modules, sysctls, swap state, runtime, staged artifacts, and CA/registry configuration.

> **Default offline registry:** `kuberegistry.dev.kube/rke2`  
> **Default credentials:** `admin` / `ZAQwsx!@#123`  
> **Default DNS list (server or agent):** `10.0.1.34,10.231.1.34`

---

## Repository layout

```
rke2nodeinit_release_repo_v2/
‚îú‚îÄ rke2nodeinit.sh          # Main script (well-commented, readable)
‚îú‚îÄ README.md                # This document
‚îú‚îÄ certs/
‚îÇ  ‚îî‚îÄ kuberegistry-ca.crt   # <-- place your registry CA here (required)
‚îú‚îÄ logs/                    # Logs (created automatically)
‚îú‚îÄ outputs/
‚îÇ  ‚îú‚îÄ images-manifest.txt   # Generated by `push`
‚îÇ  ‚îú‚îÄ images-manifest.json  # Generated by `push`
‚îÇ  ‚îî‚îÄ sbom/                 # Per-image SBOMs (SPDX via syft if available)
‚îî‚îÄ examples/
   ‚îú‚îÄ pull.yaml             # kind: Pull
   ‚îú‚îÄ push.yaml             # kind: Push
   ‚îú‚îÄ image.yaml            # kind: Image
   ‚îú‚îÄ server.yaml           # kind: Server
   ‚îî‚îÄ agent.yaml            # kind: Agent
```

---

## Requirements (entry-level friendly)

- A clean **Ubuntu 24.04 LTS** VM.
- Ability to run commands as **root** (use `sudo`).
- Your private registry‚Äôs **CA certificate** file as `certs/kuberegistry-ca.crt`.
- Optional Internet access **only for the `pull` step** (artifact download). All later steps can be fully offline.

> If `containerd` and `nerdctl` are missing, the script installs them automatically. If Docker is pre-installed and containerd is not running, Docker will be used.

---

## TL;DR ‚Äî Golden image workflow

1) **Download artifacts** and load images into the local runtime (cache):
```bash
sudo ./rke2nodeinit.sh -f examples/pull.yaml
```
2) **Push** images to your offline registry for use by other nodes:
```bash
sudo ./rke2nodeinit.sh -f examples/push.yaml
# Preview only (no push), generate manifest & SBOMs:
sudo ./rke2nodeinit.sh push --dry-push
```
3) **Prepare the template VM** for offline use (installs prereqs, stages artifacts, disables IPv6, patches OS, then reboots):
```bash
sudo ./rke2nodeinit.sh -f examples/image.yaml
```
4) **After reboot**, configure the VM to be a **Server** or **Agent** (prompts for any missing values):
```bash
sudo ./rke2nodeinit.sh -f examples/server.yaml  -y
sudo ./rke2nodeinit.sh -f examples/agent.yaml   -y
```
5) **Sanity check** anytime:
```bash
sudo ./rke2nodeinit.sh verify
```

---

## Using YAML (Kubernetes-style)

- Every file contains **exactly one** object.
- `apiVersion: rkeprep/v1`
- `kind: Pull | Push | Image | Server | Agent`
- `metadata.name`: free-form name string
- `spec`: fields in **camelCase**

### Pull ‚Äî fields
```yaml
apiVersion: rkeprep/v1
kind: Pull
metadata:
  name: rke2-artifacts
spec:
  rke2Version: v1.33.1+rke2r1   # optional; auto-detects if omitted
  registry: kuberegistry.dev.kube/rke2
  registryUsername: admin
  registryPassword: ZAQwsx!@#123
```
**What it does**: downloads the RKE2 image archive & tarball, verifies checksums, saves the installer, and **loads** the images into the local runtime cache.

### Push ‚Äî fields
```yaml
apiVersion: rkeprep/v1
kind: Push
metadata:
  name: push-to-offline-registry
spec:
  registry: kuberegistry.dev.kube/rke2
  registryUsername: admin
  registryPassword: ZAQwsx!@#123
```
**What it does**: logs in, loads the images archive if needed, then **retags & pushes** all images to your registry. Also writes:
- `outputs/images-manifest.txt`
- `outputs/images-manifest.json`
- SBOMs under `outputs/sbom/` (SPDX via `syft`, else fallback `inspect` JSON)

> Use `--dry-push` to produce reports & SBOMs **without** pushing.

### Image ‚Äî fields
```yaml
apiVersion: rkeprep/v1
kind: Image
metadata:
  name: template-prep
spec:
  defaultDns: ["10.0.1.34", "10.231.1.34"]
  defaultSearchDomains: ["corp.local", "dev.kube"]
  registry: kuberegistry.dev.kube/rke2
  registryUsername: admin
  registryPassword: ZAQwsx!@#123
```
**What it does**: installs RKE2 prerequisites; installs & trusts the registry CA; stages the RKE2 images tar and tarball for offline installation; writes `registries.yaml`; **disables IPv6**; applies **all OS updates**; then **auto-reboots**.

### Server ‚Äî fields
```yaml
apiVersion: rkeprep/v1
kind: Server
metadata:
  name: c1-s1
spec:
  ip: 10.0.0.10
  prefix: 24
  hostname: c1-s1
  dns: ["10.0.1.34", "10.231.1.34"]
  searchDomains: ["corp.local", "dev.kube"]
```
**What it does**: performs an offline install using staged artifacts; enables `rke2-server`; sets hostname & static IP (single gateway optional); configures DNS and search domains; **prompts to reboot** (or `-y` to auto-reboot).

### Agent ‚Äî fields
```yaml
apiVersion: rkeprep/v1
kind: Agent
metadata:
  name: c1-a1
spec:
  ip: 10.0.0.11
  prefix: 24
  hostname: c1-a1
  dns: ["10.0.1.34", "10.231.1.34"]
  searchDomains: ["corp.local", "dev.kube"]
  serverURL: https://10.0.0.10:9345   # optional
  token: <cluster-join-token>         # optional
```
**What it does**: performs an offline install using staged artifacts; enables `rke2-agent`; sets hostname & static IP; optionally writes `server` and `token` to `/etc/rancher/rke2/config.yaml`; **prompts to reboot** (or `-y`).

---

## Logging & Auditing

- **Console + file** logging (RFC 5424-style) to `./logs/rke2nodeinit_<UTC-timestamp>.log`
- Logs compressed after **60 days**.
- `push` writes **image manifests** and **SBOMs** under `./outputs/`.

> Tip: Forward the `logs/` directory to your **SIEM** (e.g., Splunk) and index by filename and timestamp.

---

## Security notes

- Secrets (`registryPassword`, `token`) are **masked** when printing YAML (`-P` flag).
- Swap is disabled; nftables-backed iptables is preferred.
- Registry CA is installed into the system trust store and referenced by `registries.yaml`.
- Only a **single gateway** is supported (by design for simplicity and determinism).

---

## Troubleshooting & FAQ

**Q: `verify` fails on modules/sysctls.**  
A: Re-run `image` (or ensure prereqs via `install_rke2_prereqs` are applied), then reboot and re-run `verify`.

**Q: Pushing images fails with authentication errors.**  
A: Confirm registry, username, and password in the YAML. Ensure CA is present at `certs/kuberegistry-ca.crt` and trusted on the VM (`update-ca-certificates` is run by `image`).

**Q: I don‚Äôt see SBOM files.**  
A: If the `syft` binary is not installed, the script writes an **inspect JSON** fallback instead of SPDX. Install `syft` for SPDX SBOMs.

**Q: Can I specify the RKE2 version?**  
A: Yes‚Äîvia `spec.rke2Version` in `pull.yaml` or `-v <version>` on the CLI. Otherwise, the script auto-detects the latest release.

**Q: Why IPv6 is disabled?**  
A: To reduce complexity in air-gapped environments and avoid dual-stack routing surprises. You can re-enable if desired.

---

## Safety prompts & overrides

- When `-f/--file` is used, **YAML values override** conflicting CLI flags. The script logs a warning and proceeds.
- `server` and `agent` **prompt** for any missing inputs and **confirm** reboots unless `-y` is given.

---

## Verify checklist (what ‚Äúgood‚Äù looks like)

- `verify` shows **OK** for:
  - modules: `br_netfilter`, `overlay`
  - sysctl: `bridge-nf-call-iptables=1`, `ip_forward=1`
  - **swap disabled**
  - runtime: containerd+nerdctl (preferred) or Docker
  - artifacts present: images tar, RKE2 tarball, `install.sh` staged
  - `registries.yaml` and CA cert installed

---

## Uninstall / rollback (manual)

- Remove RKE2 packages and configs (if installed):  
  `systemctl disable --now rke2-server rke2-agent || true`  
  `rm -rf /etc/rancher/rke2 /var/lib/rancher/rke2 /var/lib/kubelet`
- Remove staged artifacts (if desired):  
  `rm -rf /opt/rke2/stage /var/lib/rancher/rke2/agent/images`
- Restore swap and sysctl as needed; remove `/etc/modules-load.d/rke2.conf` and `/etc/sysctl.d/90-rke2.conf`; `sysctl --system`

---

## Examples (ready to edit)

The `examples/` folder contains working starting points for each `kind`:
- `pull.yaml`, `push.yaml`, `image.yaml`, `server.yaml`, `agent.yaml`

Happy clustering! üöÄ
